<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘å¸ƒè°ƒè¯•é¡µé¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
        <h1 class="text-2xl font-bold text-center mb-6">å‘å¸ƒè°ƒè¯•é¡µé¢</h1>

        <!-- é‚®ç®±è¾“å…¥ -->
        <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="email">
                é‚®ç®±åœ°å€
            </label>
            <input
                type="email"
                id="email"
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                placeholder="your-email@example.com"
                value="elenatang1001@163.com"
            >
        </div>

        <!-- å‘é€OTPæŒ‰é’® -->
        <button
            id="sendOtpBtn"
            class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full mb-4"
            onclick="sendOTP()"
        >
            1. è·å–OTP
        </button>

        <!-- OTPè¾“å…¥ -->
        <div id="otpSection" class="hidden mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="otp">
                è¾“å…¥OTPéªŒè¯ç 
            </label>
            <input
                type="text"
                id="otp"
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline text-center text-2xl tracking-widest font-mono"
                maxlength="6"
                placeholder="123456"
            >
        </div>

        <!-- ç™»å½•æŒ‰é’® -->
        <button
            id="loginBtn"
            class="hidden bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded w-full mb-4"
            onclick="login()"
        >
            2. ç™»å½•è·å–Token
        </button>

        <!-- å‘å¸ƒæŒ‰é’® -->
        <button
            id="publishBtn"
            class="hidden bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded w-full mb-4"
            onclick="publishVideo()"
        >
            3. å‘å¸ƒæµ‹è¯•è§†é¢‘
        </button>

        <!-- æ£€æŸ¥å‘å¸ƒè®°å½•æŒ‰é’® -->
        <button
            id="checkBtn"
            class="hidden bg-orange-500 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded w-full mb-4"
            onclick="checkPublications()"
        >
            4. æ£€æŸ¥å‘å¸ƒè®°å½•
        </button>

        <!-- ç»“æœæ˜¾ç¤º -->
        <div id="result" class="mt-4 text-center"></div>
        <div id="debug" class="mt-4 p-4 bg-gray-100 rounded text-sm font-mono text-left max-h-60 overflow-y-auto"></div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3001/api';
        let sessionToken = '';

        function log(message) {
            const debug = document.getElementById('debug');
            const timestamp = new Date().toLocaleTimeString();
            debug.innerHTML += `[${timestamp}] ${message}\n`;
            debug.scrollTop = debug.scrollHeight;
            console.log(message);
        }

        function showResult(message, isError = false) {
            const result = document.getElementById('result');
            result.innerHTML = `<span class="${isError ? 'text-red-500' : 'text-green-500'}">${message}</span>`;
        }

        async function sendOTP() {
            const email = document.getElementById('email').value;
            const btn = document.getElementById('sendOtpBtn');

            if (!email) {
                showResult('è¯·è¾“å…¥é‚®ç®±åœ°å€', true);
                return;
            }

            log(`ğŸ“§ è¯·æ±‚OTP: ${email}`);
            btn.disabled = true;
            btn.textContent = 'å‘é€ä¸­...';

            try {
                const response = await fetch(`${API_BASE_URL}/auth/send-otp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                const data = await response.json();
                log(`ğŸ“¨ OTPå“åº”: ${JSON.stringify(data)}`);

                if (data.success) {
                    showResult('OTPå‘é€æˆåŠŸï¼è¯·æŸ¥çœ‹æ§åˆ¶å°è·å–éªŒè¯ç ');
                    document.getElementById('otpSection').classList.remove('hidden');
                    document.getElementById('loginBtn').classList.remove('hidden');
                    log(`âœ… å¼€å‘æ¨¡å¼OTP: ${data.otp}`);
                } else {
                    showResult(`OTPå‘é€å¤±è´¥: ${data.message}`, true);
                }
            } catch (error) {
                showResult('OTPå‘é€å‡ºé”™', true);
                log(`âŒ OTPé”™è¯¯: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = '1. è·å–OTP';
            }
        }

        async function login() {
            const email = document.getElementById('email').value;
            const otp = document.getElementById('otp').value;
            const btn = document.getElementById('loginBtn');

            if (!otp || otp.length !== 6) {
                showResult('è¯·è¾“å…¥6ä½OTPéªŒè¯ç ', true);
                return;
            }

            log(`ğŸ” ç™»å½•: ${email} with OTP: ${otp}`);
            btn.disabled = true;
            btn.textContent = 'ç™»å½•ä¸­...';

            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, otp })
                });

                const data = await response.json();
                log(`ğŸ”‘ ç™»å½•å“åº”: ${JSON.stringify(data, null, 2)}`);

                if (data.success) {
                    sessionToken = data.sessionToken;
                    showResult('ç™»å½•æˆåŠŸï¼');
                    document.getElementById('publishBtn').classList.remove('hidden');
                    document.getElementById('checkBtn').classList.remove('hidden');
                    log(`ğŸ« Token: ${sessionToken}`);
                } else {
                    showResult(`ç™»å½•å¤±è´¥: ${data.message}`, true);
                }
            } catch (error) {
                showResult('ç™»å½•å‡ºé”™', true);
                log(`âŒ ç™»å½•é”™è¯¯: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = '2. ç™»å½•è·å–Token';
            }
        }

        async function publishVideo() {
            const btn = document.getElementById('publishBtn');

            if (!sessionToken) {
                showResult('è¯·å…ˆç™»å½•è·å–token', true);
                return;
            }

            const videoData = {
                title: 'å‰ç«¯è°ƒè¯•æµ‹è¯•è§†é¢‘',
                titleEn: 'Frontend Debug Test Video',
                categoryId: '6951ff1da54da130be8b068b',
                videoUrl: 'https://example.com/debug-test.mp4',
                coverUrl: 'https://example.com/debug-test.jpg',
                duration: 45
            };

            log(`ğŸ¬ å‘å¸ƒè§†é¢‘: ${JSON.stringify(videoData, null, 2)}`);
            btn.disabled = true;
            btn.textContent = 'å‘å¸ƒä¸­...';

            try {
                const response = await fetch(`${API_BASE_URL}/videos/publish`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionToken}`
                    },
                    body: JSON.stringify(videoData)
                });

                const data = await response.json();
                log(`ğŸ“¤ å‘å¸ƒå“åº”: ${JSON.stringify(data, null, 2)}`);

                if (data.success) {
                    showResult('è§†é¢‘å‘å¸ƒæˆåŠŸï¼');
                    log(`âœ… è§†é¢‘ID: ${data.data.id}`);
                    log(`ğŸ“Š è§†é¢‘çŠ¶æ€: ${data.data.status}`);
                } else {
                    showResult(`å‘å¸ƒå¤±è´¥: ${data.message}`, true);
                }
            } catch (error) {
                showResult('å‘å¸ƒå‡ºé”™', true);
                log(`âŒ å‘å¸ƒé”™è¯¯: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = '3. å‘å¸ƒæµ‹è¯•è§†é¢‘';
            }
        }

        async function checkPublications() {
            const btn = document.getElementById('checkBtn');

            if (!sessionToken) {
                showResult('è¯·å…ˆç™»å½•è·å–token', true);
                return;
            }

            log(`ğŸ“‹ æ£€æŸ¥å‘å¸ƒè®°å½•`);
            btn.disabled = true;
            btn.textContent = 'æ£€æŸ¥ä¸­...';

            try {
                const response = await fetch(`${API_BASE_URL}/users/publications?page=1&limit=20`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });

                const data = await response.json();
                log(`ğŸ“Š å‘å¸ƒè®°å½•å“åº”: ${JSON.stringify(data, null, 2)}`);

                if (data.success) {
                    const count = data.data.length;
                    const titles = data.data.map(v => v.title).join(', ');
                    showResult(`æ‰¾åˆ° ${count} ä¸ªè§†é¢‘: ${titles}`);
                    log(`ğŸ“ è§†é¢‘åˆ—è¡¨: ${titles}`);
                } else {
                    showResult(`è·å–å¤±è´¥: ${data.message}`, true);
                }
            } catch (error) {
                showResult('æ£€æŸ¥å‡ºé”™', true);
                log(`âŒ æ£€æŸ¥é”™è¯¯: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = '4. æ£€æŸ¥å‘å¸ƒè®°å½•';
            }
        }

        // å›è½¦é”®æ”¯æŒ
        document.getElementById('email').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendOTP();
            }
        });

        document.getElementById('otp').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });
    </script>
</body>
</html>
